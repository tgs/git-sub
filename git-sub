#/bin/bash

USAGE="no idea"
LONG_USAGE="no idea"
SUBDIRECTORY_OK="yes"
. git-sh-setup
cd_to_toplevel
set -eu

function git_sub_commit_from_svn() {
	SOURCE_COMMIT=$(git rev-parse --revs-only $1)
	if ! git rev-parse from-svn > /dev/null; then
		COMMIT=git commit-tree ${SOURCE_COMMIT}^{tree}
	else
		COMMIT=git commit-tree ${SOURCE_COMMIT}^{tree} -p from-svn
	fi
	git update-ref from-svn $COMMIT
}
		
function read_note_pointer() {
	rev_in=`git rev-parse $1`
	GIT_NOTES_REF='refs/notes/git-sub' git notes -l $rev_in
}
		

function git_sub_init() {
	for SVNREV in `git rev-list refs/remotes/git-svn`; do
		echo $SVNREV
	done
	#git commit-tree refs/remotes/git-svn^{tree} ...
	git branch --no-track for-svn refs/remotes/git-svn
	git branch --no-track from-svn refs/remotes/git-svn
}

if [ $# -lt 1 ]; then
	die "Subcommand required"
fi

case "$1" in
init)
	git_sub_init ;;
read-note-pointer)
	read_note_pointer "$@" ;;
commit-from-svn)
	git_sub_commit_from_svn "$@" ;;
*)
	die "Unknown git sub command" ;;
esac


